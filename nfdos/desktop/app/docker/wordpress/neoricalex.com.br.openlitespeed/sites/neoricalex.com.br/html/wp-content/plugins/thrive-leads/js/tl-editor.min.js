/*! Thrive Leads - The ultimate Lead Capture solution for wordpress - 2021-01-22
* https://thrivethemes.com 
* Copyright (c) 2021 * Thrive Themes */

var TL_Editor=TL_Editor||{},TCB_AnimViews=TVE.Views.Components.AnimationViews;TL_Editor.views=TL_Editor.views||{},TVE.leads=TVE.leads||{},TL_Editor.views.ModalTemplates=TVE.modal.base.extend({el:TVE.modal.get_element("tl-templates"),saved_tpl_delete_confirmation:TVE.tpl("templates/delete-confirmation"),events:function(){return _.extend({},TVE.modal.base.prototype.events(),{"click .tcb-cancel-delete-template":"no_delete_template","click .tcb-apply-delete-template":"yes_delete_template","click .tcb-modal-cancel":"close","click .tcb-modal-save":"save","click .tab-item":"tab_click","click .tve-template-item .template-wrapper":function(a){this.$(".template-wrapper.active").removeClass("active"),a.currentTarget.classList.toggle("active")}})},initialize:function(){TVE.modal.base.prototype.initialize.apply(this,arguments),this.$tabs=this.$(".tab-item"),this.$content=this.$(".tve-tab-content"),this.$default_templates=this.$(".tve-default-templates-list"),this.$saved_templates=this.$(".tve-saved-templates-list"),this.set_templates(TVE.CONST.tl_templates)},delete_confirmation:function(a){var b=jQuery(a.currentTarget).closest(".tve-template-item");b.find(".template-wrapper").hide(),b.append(this.saved_tpl_delete_confirmation())},no_delete_template:function(a){var b=jQuery(a.currentTarget).closest(".tve-template-item");b.find(".template-wrapper").show(),b.find(".tcb-delete-template-confirmation").remove()},yes_delete_template:function(a){var b=jQuery(a.currentTarget).closest(".tve-template-item"),c={external_action:tve_leads_page_data.tpl_action,route:"delete",tpl:b.attr("data-id"),post_id:TVE.CONST.post_id,_key:tve_leads_page_data._key};TVE.main.overlay(),TVE.ajax("save_post_external","post",c).done(function(a){b.remove(),TVE.main.overlay("close")})},has_fixed_footer:function(){return!0},save:function(){var a=this,b=this.$(".tve-template-item .active");if(b.length<=0)return TVE.page_message(TVE.t.SelectTemplate,!0,5e3);var c=b.data("id"),d=this.templates.findWhere({id:c});if(!(d instanceof Backbone.Model))return TVE.page_message("Something is wrong here. Template model not found ",!0);var e={tpl:d.get("key"),external_action:tve_leads_page_data.tpl_action,post_id:TVE.CONST.post_id,_key:tve_leads_page_data._key,route:"choose",cloud:d.get("cloud")||0,multi_step:d.get("multi_step")||0,form_type:d.get("form_type")||""};TVE.main.overlay(),jQuery("#tl-form-states").find(".design-states").is(":visible")&&jQuery("#tl-form-states").find("button.state-close").trigger("click"),TVE.ajax("save_post_external","post",e).done(function(b){if(!b.success&&!b.main_page_content&&1)return TVE.page_message(b.message,!0),TVE.main.overlay("close");TL_Editor.state.insertResponse(b);try{localStorage.setItem("tve_add_content_variation",JSON.stringify({form_type_id:e.post_id,variation_id:e._key}))}catch(a){}a.close()})},tab_click:function(a){var b=a.currentTarget.getAttribute("data-content");"saved"===b?this.render_saved_templates():this.templates=new Backbone.Collection(TVE.CONST.tl_templates),this.$tabs.removeClass("active"),a.currentTarget.classList.add("active"),this.$content.removeClass("active"),this.$content.filter('[data-content="'+b+'"]').addClass("active")},before_open:function(){this.render_templates(),this.$('.tab-item[data-content="default"]').trigger("click")},render_templates:function(){if(this.$default_templates.html().length>0)return this;var a=this,b=TVE.tpl("templates/item");this.templates.each(function(c,d,e){a.$default_templates.append(b({item:c}))})},render_saved_templates:function(){var a=this,b={external_action:tve_leads_page_data.tpl_action,route:"get_saved",current_template:this.$("#tl-filter-current-templates").is(":checked")?1:0,post_id:TVE.CONST.post_id,_key:tve_leads_page_data._key};TVE.main.overlay(),a.$saved_templates.html("Fetching saved templates..."),TVE.ajax("save_post_external","post",b).done(function(b){if(!b.success&&!b.main_page_content&&1)return TVE.page_message(b.message,!0),TVE.main.overlay("close");a.$saved_templates.empty();var c=TVE.tpl("templates/saved-item");a.templates=new Backbone.Collection(b.templates),0===a.templates.length?a.$saved_templates.append("No saved templates found"):a.templates.each(function(b,d,e){a.$saved_templates.append(c({item:b}))}),TVE.main.overlay("close")})},set_templates:function(a){this.templates=new Backbone.Collection(a),this.$default_templates.empty()}}),TL_Editor.views.ModalTemplateSaving=TVE.modal.base.extend({el:TVE.modal.get_element("tl-template-saving"),after_initialize:function(){this.$el.addClass("medium")},save:function(){var a=this.$("input").val();if(a.length<=0)return TVE.page_message(TVE.t.tpl_name_required,!0,5e3);var b=this,c={external_action:tve_leads_page_data.tpl_action,route:"save",post_id:TVE.CONST.post_id,_key:tve_leads_page_data._key,name:a};return TVE.main.overlay(),TVE.main.editor_settings.save(null,null,function(){TVE.ajax("save_post_external","post",c).done(function(a){if(!a.success&&1)return TVE.page_message(a.message,!0),TVE.main.overlay("close");TVE.main.overlay("close"),b.close(),TVE.page_message(a.message)})}),this}}),TVE.leads.LightboxStateAction=TCB_AnimViews.ThriveLightbox.extend({reinit:function(){this.options.actions[this.key]?(this.$el.closest(".action-item").show(),this.list.set_items(this.options.actions[this.key].options)):this.$el.closest(".action-item").hide()},controls_init:function(){this.list=new TVE.Views.Controls.List({el:this.$(".state-list")[0],items:this.options.actions[this.key].options}),this.event_trigger="click",this.$animation=this.$("#lb-animation"),TVE.CONST.options.animation.actions.tl_state_lightbox?(this.$animation.show(),_.each(TVE.CONST.options.animation.actions.tl_state_lightbox.animations,function(a,b){this.$animation.append('<option value="'+b+'">'+a+"</option>")},this)):this.$animation.hide()},set_model:function(a){return this.model=void 0!==a?a:new Backbone.Model({config:{}}),this.list.set_value(parseInt(this.model.get("config").s||0)),this.$animation.val(this.model.get("config").anim||"instant"),this},validate:function(){return!!this.list.get_value()||TVE.page_message(TVE.t.state_missing,!0)},apply_settings:function(a){return!!this.validate()&&(this.model.set({a:this.key,t:this.event_trigger,config:{anim:this.$animation.val()||"instant",s:this.list.get_value()}}),!0)}}),TVE.leads.StateSwitchAction=TVE.leads.LightboxStateAction.extend({controls_init:function(){TVE.leads.LightboxStateAction.prototype.controls_init.apply(this,arguments),this.$animation.hide()}}),function(a){TVE.add_filter("tve_form_submit_options",function(a){return _.findWhere(a,{key:"state"})||a.push({key:"state",label:tve_leads_page_data.L.switch_state,icon:"state"}),a}),a(function(){new TVE.leads.StateManager({el:a("#tl-form-states")[0]});TVE.add_filter("editor_loaded_callback",TL_Editor.tcb_editor_page_loaded),TVE.add_filter("before_editor_events",TL_Editor.before_editor_loaded),TVE.add_filter("tcb_insert_content_template",TL_Editor.pre_process_content_template),TVE.main.on("animation_update",function(b,c){var d=c.read(b);a.each(d,function(d,e){var f=e.a;if("thrive_leads_form_close"!==f){var g=parseInt(e.config.s),h=e.t,i=TVE.Components.animation.options.actions;if("click"===h){var j=i[f].options,k=[];j.length?(a.each(j,function(a,b){b.id===g&&k.push(b.id)}),k.length||c.remove(b,h)):c.remove(b,h)}}})})}),TVE.leads.StateManager=TVE.Views.Base.base_view.extend({after_initialize:function(){this.dom={btn:this.$(".states-button-container")},TL_Editor.state.fixed_height()},expand:function(){clearTimeout(this.hide_timeout),this.$(".design-states").removeClass("hide-from-view")},collapse:function(a){this.hide_timeout=setTimeout(this.bind(function(){this.$(".design-states").addClass("hide-from-view")}),200)},cancel_hide:function(){clearTimeout(this.hide_timeout)},toggle_add:function(b){a(b.currentTarget).toggleClass("tl-multistep-open")},add:function(a){var b=a.currentTarget;if(b.getAttribute("data-subscribed"))return void alert(tve_leads_page_data.L.only_one_subscribed);this.collapse(),TVE.main.overlay(),TVE.Editor_Page.save(!1,function(){TVE.KEEP_OVERLAY=!0,TL_Editor.state.ajax({custom_action:"add",state:b.getAttribute("data-state")}).done(TL_Editor.state.insertResponse)})},select:function(a){const b=a.currentTarget.getAttribute("data-id"),c=TVE.$(".preview-content"),d=c.attr("href");this.collapse(),TVE.main.overlay(),TVE.Editor_Page.save(!1,function(){TVE.KEEP_OVERLAY=!0,TL_Editor.state.ajax({custom_action:"display",id:b}).done(TL_Editor.state.insertResponse)}),c.attr("href",this.updateUrlParameter(d,"_key",b))},updateUrlParameter:function(a,b,c){var d=new RegExp("("+b+"=)[^&]+");return a.replace(d,"$1"+c)},visibility:function(b){var c=a(b.currentTarget);if(c.parents("li").hasClass("lightbox-step-active")&&void 0!==c.attr("data-visible"))return TVE.main.overlay(),this.collapse(),TL_Editor.state.ajax({custom_action:"visibility",visible:c.attr("data-visible")}).done(function(a){TVE.page_message(a.message),TL_Editor.state.insertResponse(a)}),!1},duplicate:function(a,b){return"already_subscribed"===b.getAttribute("data-state")?void alert(tve_leads_page_data.L.only_one_subscribed):(this.collapse(),TVE.main.overlay(),TVE.Editor_Page.save(!1,function(){TVE.KEEP_OVERLAY=!0,TL_Editor.state.ajax({custom_action:"duplicate",id:b.getAttribute("data-id")}).done(TL_Editor.state.insertResponse)}),!1)},remove:function(a,b){return!!confirm(tve_leads_page_data.L.confirm_state_delete)&&(this.collapse(),TVE.main.overlay(),TL_Editor.state.ajax({custom_action:"delete",id:b.getAttribute("data-id")}).done(function(a){TVE.page_message(tve_leads_page_data.L.state_deleted),TL_Editor.state.insertResponse(a)}),!1)}}),TL_Editor.state={fixed_height:function(){var b=a(".fix-height-states");"function"==typeof b.scrollbar?b.scrollbar():b.css("overflow-y","auto")},insertResponse:function(b){b||TVE.page_message("Something went wrong",!0),TVE.main&&TVE.main.$cpanel&&b.preview_link.length&&TVE.main.$cpanel.find(".preview-content").attr("href",decodeURIComponent(b.preview_link)),TL_Editor_Page.handle_state_response(b),a(".design-states").replaceWith(b.state_bar),TL_Editor.state.fixed_height(),b.tve_path_params.tl_templates&&modal_templates.set_templates(TVE.CONST.tl_templates),b.animation_options&&(TVE.Components.animation.options=b.animation_options,TVE.Components.animation.reinit(),TL_Editor.FLAG_RE_RENDER_EVENTS=!0);var c=a(".total_states");b.tve_leads_page_data.states.length>=2?(c.show(),c.html(b.tve_leads_page_data.states.length-1)):c.hide(),setTimeout(function(){TVE.main.overlay("close")},1)},ajax:function(a){return TVE.Editor_Page.blur(),a._key=tve_leads_page_data._key,a.post_id=tve_leads_page_data.post_id,a.active_state=tve_leads_page_data._key,a.external_action=tve_leads_page_data.state_action,TVE.ajax("save_post_external","post",a)}},TL_Editor.tcb_editor_page_loaded=function(){TVE.StorageManager.unset("tl_design-"+tve_leads_page_data.post_id),modal_templates=new TL_Editor.views.ModalTemplates,TVE.main.on("lgRenderOptionForm",function(b,c,d){if("state"===d){var e=TVE.tpl("lead-generation/switch-states-form"),f=a(e()),g=f.find("select"),h=function(b){var d="tl_state_switch",e=parseInt(b);c.set("_state",e),a(tve_leads_page_data.states).each(function(a,b){parseInt(e)===parseInt(b.key)&&"lightbox"===b.form_state&&(d="tl_state_lightbox")});var f={t:"click",a:d,elementType:"a",config:{s:e}};f="__TCB_EVENT_["+JSON.stringify(f)+"]_TNEVE_BCT__",TVE.ActiveElement.find(".tve-switch-state-trigger").remove();var g=a('<a href="javascript:void(0)" style="display: none;" class="tve-switch-state-trigger tve_evt_manager_listen tve_et_click"></a>');g.attr("data-tcb-events",f),TVE.Components.lead_generation.getWrapper("form").append(g)};if(g.on("change",function(a){h(a.currentTarget.value)}),a.each(tve_leads_page_data.states,function(b,c){if(parseInt(c.key)!==parseInt(tve_leads_page_data._key)&&"already_subscribed"!==c.form_state){var d=a('<option value="'+c.key+'">'+c.state_name+"</option>");g.append(d)}}),TVE.ActiveElement.find(".tve-switch-state-trigger").length){var i=JSON.parse(TVE.ActiveElement.find(".tve-switch-state-trigger").attr("data-tcb-events").replace("__TCB_EVENT_[","").replace("]_TNEVE_BCT__","")).config;g.val(i.s),TVE.ActiveElement.data("lg").set("_state",i.s)}else h(g.val());b.find("#lg-state").html(f).removeClass("tcb-hidden")}}),TVE.Components.lead_generation.on("tcb_lg_manage_submit_options",function(a,b){b._write._form_type=function(){TVE.Components.lead_generation.getWrapper("form").append(TVE.Components.lead_generation.generateHiddenInput({name:"_form_type",value:tve_leads_page_data.form_type}))}}),a(TVE.main).on("tcb.open_templates_picker",function(a){return a.preventDefault(),modal_templates.open({}),!1}),tve_leads_page_data.has_content||modal_templates.open({dismissible:!1}),TVE.main.sidebar_extra.tl_template_reset=function(){if(confirm(tve_leads_page_data.L.confirm_tpl_reset)){TVE.Editor_Page.blur(),TVE.main.sidebar_extra.hide_drawers();var a={_key:tve_leads_page_data._key,post_id:TVE.CONST.post_id,external_action:tve_leads_page_data.tpl_action,route:"reset"};TVE.main.overlay(),TVE.ajax("save_post_external","post",a).done(TL_Editor.state.insertResponse)}},TVE.main.sidebar_extra.tl_template_save=function(){if(this.modal instanceof Backbone.View)return this.modal.open();this.modal=new TL_Editor.views.ModalTemplateSaving,this.modal.open()},TVE.add_filter("link_search_lightbox",function(){return""}),TVE.add_filter("tcb_save_post_data_before",function(a){if(TVE.inner_$(".tve_p_lb_content").length){var b,c=TVE.CONST.tve_globals,d=TVE.inner_$(".tve_p_lb_content");(b=d.attr("data-css"))&&(c.content_css=b)}return a}),TVE.add_action("tve.save_post.success",function(){TVE.StorageManager.set("tl_design-"+tve_leads_page_data.post_id,!0)}),TVE.add_action("component.update.layout.tl-slide-in",function(a){a.disable_extra_controls(["right","left"].map(function(a){return"margin-"+a}))})},TL_Editor.before_editor_loaded=function(){var b=1,c=["thrive_leads_form_close","tl_state_lightbox","tl_state_switch"];TVE.add_filter("tcb_froala_config",function(){return{linkEventActions:{getHtml:function(){var a=TVE.Components.animation.options.actions,c={thrive_leads_form_close:a.thrive_leads_form_close};return a.tl_state_switch&&a.tl_state_switch.options.length&&(c.tl_state_switch=a.tl_state_switch),a.tl_state_lightbox&&a.tl_state_lightbox.options.length&&(c.tl_state_lightbox=a.tl_state_lightbox),TVE.tpl("froala-leads-states")({actions:c,current_id:++b})},bindEvents:function(a){a.on("change",".fr-extra-action",function(b){a.find(".tl-action-config").hide(),this.checked?(a.find(".tl-action-opts-"+this.getAttribute("data-key")).show(),a.find(".fr-link-atts,.fr-link-url").hide(),a.find(".fr-extra-action").not(this).prop("checked",!1)):a.find(".fr-link-atts,.fr-link-url").show()})},hasSelected:function(a){return a.find(".fr-extra-action:checked").length},getEventConfig:function(a){var b={};return b.a=a.find(".fr-extra-action:checked").attr("data-key"),b.t="click",b.config={s:a.find(".tl-action-opts-"+b.a+' select[name="s"]').val(),anim:a.find(".tl-action-opts-"+b.a+' select[name="a"]').val()},b},reset:function(a){TL_Editor.FLAG_RE_RENDER_EVENTS&&(a.find(".tl-link-actions").replaceWith(this.getHtml()),delete TL_Editor.FLAG_RE_RENDER_EVENTS),a.find(".fr-extra-action").prop("checked",!1),a.find(".fr-link-atts,.fr-link-url").show(),a.find(".tl-action-config").hide()},updateFromLink:function(b,d){var e=!1;if(this.reset(d),b.hasClass("tve_evt_manager_listen")){var f=TVE.EventManager.get(b,"click");f&&-1!==a.inArray(f.a,c)&&(d.find('.fr-extra-action[data-key="'+f.a+'"]').prop("checked",!0).trigger("change"),d.find(".tl-action-opts-"+f.a+' select[name="s"]').val(f.config.s),e=!0,d.find(".tl-action-opts-"+f.a+' select[name="a"]').val(f.config.anim||"instant"))}return e}}}});var d=TVE.CustomHTML;TVE.CustomHTML=TVE.CustomHTML.extend({append_extra_settings:function(){this.$(".extra-settings").remove()},after_initialize:function(){d.prototype.after_initialize.apply(this,arguments),this.$(".tcb-modal-title").after(TVE.tpl("custom-html-options")()),this.$lazy_load=this.$("#custom-html-lazy-load")},before_open:function(){d.prototype.before_open.apply(this,arguments),this.$("#tl-custom-html-opts").toggle(!tve_leads_page_data.is_default_state)},is_lazy_load:function(){return!tve_leads_page_data.is_default_state&&"lazy"===this.$lazy_load.val()},prepare_content_for_save:function(a){return this.is_lazy_load()&&(a='<script type="text/template" style="display: none" class="tcb-lazyload-template">'+a+"</script>"),a},prepare_content_for_load:function(){var a,b=TVE.ActiveElement.children().first();return 1===b.length&&b.is('script.tcb-lazyload-template[type="text/template"]')?(this.$lazy_load.val("lazy"),a=b.html()):a=TVE.ActiveElement.html(),a}})}}(jQuery);